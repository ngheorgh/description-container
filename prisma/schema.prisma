// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Shop {
  id          String   @id @default(uuid())
  shopDomain  String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  products            Product[]
  collections         Collection[]
  metafieldDefinitions MetafieldDefinition[]
  templates           SpecificationTemplate[]
  assignments         TemplateAssignment[]
  templateLookups     TemplateLookup[]
  webhookEvents       WebhookEvent[]
  setupProgress       SetupProgress?
  syncStatus          SyncStatus?
  shopPlan            ShopPlan?
}

model Product {
  id          String   @id @default(uuid())
  shopifyId   String
  title       String
  handle      String?
  shopId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@unique([shopifyId, shopId])
  @@index([shopId])
}

model Collection {
  id          String   @id @default(uuid())
  shopifyId   String
  title       String
  handle      String?
  shopId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@unique([shopifyId, shopId])
  @@index([shopId])
}

model MetafieldDefinition {
  id          String   @id @default(uuid())
  namespace   String
  key         String
  name        String?
  type        String
  ownerType   String   // "PRODUCT" or "VARIANT"
  shopId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  templateSectionMetafields TemplateSectionMetafield[]
  
  @@unique([namespace, key, ownerType, shopId])
  @@index([shopId])
}

model SpecificationTemplate {
  id            String   @id @default(uuid())
  name          String
  shopId        String
  styling       String   // JSON string with styling config
  isActive      Boolean  @default(true)
  isAccordion   Boolean  @default(false)
  isAccordionHideFromPC   Boolean  @default(false) // Ascunde accordion pe desktop
  isAccordionHideFromMobile Boolean @default(false) // Ascunde accordion pe mobile
  seeMoreEnabled Boolean @default(false)
  seeMoreHideFromPC   Boolean  @default(false) // Ascunde "See more" pe desktop
  seeMoreHideFromMobile Boolean @default(false) // Ascunde "See more" pe mobile
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  shop        Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  sections    TemplateSection[]
  assignments TemplateAssignment[]
  lookups     TemplateLookup[]
  
  @@index([shopId])
  @@index([shopId, isActive])
}

model TemplateSection {
  id          String   @id @default(uuid())
  templateId  String
  heading     String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  template    SpecificationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  metafields  TemplateSectionMetafield[]
  
  @@index([templateId])
}

model TemplateSectionMetafield {
  id                    String   @id @default(uuid())
  sectionId             String
  metafieldDefinitionId String
  order                 Int      @default(0)
  customName            String?  // Nume personalizat pentru acest template
  tooltipEnabled        Boolean  @default(false) // Dacă tooltip-ul este activat
  tooltipText           String?  // Textul tooltip-ului
  hideFromPC           Boolean  @default(false) // Ascunde metafield-ul pe desktop
  hideFromMobile        Boolean  @default(false) // Ascunde metafield-ul pe mobile
  createdAt             DateTime @default(now())
  
  section               TemplateSection      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  metafieldDefinition   MetafieldDefinition @relation(fields: [metafieldDefinitionId], references: [id], onDelete: Cascade)
  
  @@unique([sectionId, metafieldDefinitionId])
  @@index([sectionId])
  @@index([sectionId, order])
}

enum AssignmentType {
  PRODUCT
  COLLECTION
  DEFAULT
}

model TemplateAssignment {
  id            String         @id @default(uuid())
  templateId   String
  assignmentType AssignmentType
  shopId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  
  template     SpecificationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  shop         Shop                  @relation(fields: [shopId], references: [id], onDelete: Cascade)
  targets      TemplateAssignmentTarget[]
  
  @@index([shopId])
  @@index([templateId])
  @@index([shopId, assignmentType])
  @@index([shopId, templateId, assignmentType])
}

model TemplateAssignmentTarget {
  id            String   @id @default(uuid())
  assignmentId  String
  targetShopifyId String // Product or Collection Shopify ID
  targetType    String   // "PRODUCT" or "COLLECTION"
  isExcluded    Boolean  @default(false) // For exclusion rules
  createdAt     DateTime @default(now())
  
  assignment    TemplateAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  @@index([assignmentId])
  @@index([targetShopifyId])
  @@index([assignmentId, targetShopifyId, isExcluded])
  @@index([targetShopifyId, targetType])
}

/**
 * Tabel de lookup denormalizat pentru performanță maximă
 * Stochează direct mapping-ul productId/collectionId -> templateId cu prioritate
 * Priority: 1=PRODUCT, 2=COLLECTION, 3=DEFAULT
 */
model TemplateLookup {
  id            String   @id @default(uuid())
  shopId        String
  productId     String?  // ID-ul normalizat al produsului (nullable)
  collectionId  String?  // ID-ul normalizat al colecției (nullable)
  templateId    String
  priority      Int      // 1=PRODUCT, 2=COLLECTION, 3=DEFAULT
  isDefault     Boolean  @default(false) // true pentru DEFAULT assignments (evită mii de rânduri)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  shop          Shop                  @relation(fields: [shopId], references: [id], onDelete: Cascade)
  template      SpecificationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Indexuri pentru lookup rapid
  // Covering indexes (include templateId pentru a evita lookup suplimentar)
  @@index([shopId, productId, priority, templateId])
  @@index([shopId, collectionId, priority, templateId])
  @@index([shopId, isDefault, priority, templateId])
  @@unique([shopId, productId, collectionId, priority])
}

/**
 * Tabel pentru monitorizarea webhook-urilor
 * Stochează toate evenimentele webhook pentru debugging și monitoring
 */
model WebhookEvent {
  id            String   @id @default(uuid())
  shopId        String
  topic         String   // "products/create", "collections/update", etc.
  status        String   // "success" sau "error"
  errorMessage  String?  // Mesajul de eroare dacă status = "error"
  payload       String?  // Payload-ul webhook-ului (JSON string, opțional pentru debugging)
  responseTime  Int?     // Timpul de răspuns în ms
  createdAt     DateTime @default(now())
  
  shop          Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@index([shopId, topic])
  @@index([shopId, status])
  @@index([shopId, createdAt])
  @@index([topic, status])
}

/**
 * Tabel pentru tracking-ul progresului de setup al aplicației
 * Stochează starea fiecărui pas din Setup Guide
 */
model SetupProgress {
  id                      String   @id @default(uuid())
  shopId                  String   @unique
  step1_themeSelected     Boolean  @default(false)
  step1_selectedThemeId   String?  // ID-ul temei selectate
  step1_selectedThemeName String?  // Numele temei selectate
  step2_extensionApplied  Boolean  @default(false)
  step3_extensionActivated Boolean @default(false)
  step4_templateCreated   Boolean  @default(false)
  step5_assignmentConfigured Boolean @default(false)
  step6_tested            Boolean  @default(false)
  completedAt             DateTime?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  shop                    Shop     @relation(fields: [shopId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
}

model SyncStatus {
  id   String @id @default(uuid())
  shopId String @unique

  // Lock simplu pentru a preveni multiple initial sync-uri în paralel
  syncInProgress Boolean @default(false)
  syncStartedAt  DateTime?

  // Counts in App DB
  appProducts           Int @default(0)
  appCollections        Int @default(0)
  appProductMetafields  Int @default(0)
  appVariantMetafields  Int @default(0)

  // Counts in Shopify Store (nullable până la primul check)
  shopifyProducts          Int?
  shopifyCollections       Int?
  shopifyProductMetafields Int?
  shopifyVariantMetafields Int?

  // Timestamps / status
  lastAppUpdateAt     DateTime?
  lastShopifyCheckAt  DateTime?
  lastFullSyncAt      DateTime?
  lastWebhookAt       DateTime?
  lastComparisonOk    Boolean?
  lastMismatchDetails String?

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
}

/**
 * Plan selectat de merchant (folosit pentru gating/feature flags mai târziu)
 */
model ShopPlan {
  id        String   @id @default(uuid())
  shopId    String   @unique
  planKey   String   // "free" | "starter" | "growth" | "enterprise" (extensibil)
  productsCountAtSelection Int
  selectedAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
}